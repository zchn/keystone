$name?="keystone-unleashed"

using sysbus
mach create $name
machine LoadPlatformDescription @@renode_wrkdir@/keystone_board.repl

showAnalyzer uart0

$bootrom?=@@bootrom_wrkdir@/bootrom.elf
$fdt?=@@renode_wrkdir@/hifive-unleashed-renode.dtb
$sm?=@@fw_bin@
$vmlinux?=@@linux_wrkdir@/vmlinux

macro reset
"""
    # Loads the bootrom at 0x1000. The load address is inferred from the ELF header.
    # This will also help setting the pc register of all CPUs to 0x1000.
    sysbus LoadELF $bootrom

    # Loads the device tree file at address 0x82000000.
    # TODO: Use LoadFdt instead of LoadBinary since LoadFdt has some useful sanity checks.
    sysbus LoadBinary $fdt 0x82000000
    # Sets the a1 register (i.e. x11 register) to the location of the device tree file so
    # the bootloader knows where to find it.
    e51 SetRegisterUnsafe 11 0x82000000

    # Load the Security Monitor and the Linux kernel at the beginning of the DRAM.
    sysbus LoadBinary $sm 0x80000000

    # Load the debugging symbols for Linux.
    sysbus LoadSymbolsFrom $vmlinux

    emulation CreateSwitch "switch1"
    connector Connect sysbus.ethernet switch1
    emulation CreateTap "tap0" "tap"
    connector Connect host.tap switch1
"""
runMacro $reset
